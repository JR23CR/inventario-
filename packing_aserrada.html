<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Packing List - Madera Aserrada - GIBOR S.A.</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        @media print {
            .no-print { display: none !important; }
            body { background: white; }
            .print-container { box-shadow: none; border: none; }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans p-4 md:p-8">

    <div class="max-w-6xl mx-auto bg-white shadow-2xl rounded-3xl overflow-hidden print-container">
        <div class="p-8 border-b-4 border-blue-900">
            <div class="flex justify-between items-start mb-6">
                <div class="flex items-center gap-4">
                    <img src="logo-giborv2 (2).png" alt="GIBOR S.A." class="h-20 w-auto object-contain" onerror="this.src='https://via.placeholder.com/150?text=LOGO+GIBOR'">
                    <div>
                        <h1 class="text-2xl font-black text-blue-900 uppercase tracking-tighter">Packing List</h1>
                        <p class="text-sm font-bold text-slate-500 uppercase tracking-widest">Madera Aserrada</p>
                    </div>
                </div>
                <div class="text-right no-print">
                    <button onclick="exportarExcel()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 transition-all">
                        <i data-lucide="file-spreadsheet"></i> Descargar Excel
                    </button>
                    <a href="menu_aserrada.html" class="inline-block mt-2 text-xs font-bold text-slate-400 hover:text-blue-600 uppercase">â¬… Volver al MenÃº</a>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
                <div class="space-y-1">
                    <label class="font-bold text-slate-400 uppercase text-[10px]">Tipo de Documento</label>
                    <select id="tipoDocumento" class="w-full font-bold border-b border-gray-200 focus:border-blue-500 outline-none pb-1 bg-transparent text-slate-700">
                        <option value="cliente">Packing List (Cliente)</option>
                        <option value="despacho">Orden de Despacho</option>
                        <option value="gerencial">Reporte Gerencial (Especie/Calidad)</option>
                    </select>
                </div>
                <div class="space-y-1">
                    <label class="font-bold text-slate-400 uppercase text-[10px]">Fecha</label>
                    <input type="text" id="fecha" class="w-full font-bold border-b border-gray-200 focus:border-blue-500 outline-none pb-1">
                </div>
                <div class="space-y-1">
                    <label class="font-bold text-slate-400 uppercase text-[10px]">Producto</label>
                    <input type="text" id="producto" value="Madera Aserrada" class="w-full font-bold border-b border-gray-200 focus:border-blue-500 outline-none pb-1">
                </div>
                <div class="space-y-1">
                    <label class="font-bold text-slate-400 uppercase text-[10px]">Especie</label>
                    <input type="text" id="especie" list="listaEspecies" placeholder="Ej: CAOBA" oninput="this.value = this.value.toUpperCase()" class="w-full font-bold border-b border-gray-200 focus:border-blue-500 outline-none pb-1">
                    <datalist id="listaEspecies"></datalist>
                </div>
                <div class="space-y-1">
                    <label class="font-bold text-slate-400 uppercase text-[10px]">Calidad</label>
                    <input type="text" id="calidad" list="listaCalidades" placeholder="Ej: COMUN Y MEJOR" oninput="this.value = this.value.toUpperCase()" class="w-full font-bold border-b border-gray-200 focus:border-blue-500 outline-none pb-1">
                    <datalist id="listaCalidades"></datalist>
                </div>
                <div class="space-y-1">
                    <label class="font-bold text-slate-400 uppercase text-[10px]">Grosor</label>
                    <input type="text" id="headerGrosor" list="listaGrosores" placeholder="Ej: 4/4" class="w-full font-bold border-b border-gray-200 focus:border-blue-500 outline-none pb-1">
                    <datalist id="listaGrosores"></datalist>
                </div>
                <div class="space-y-1">
                    <label class="font-bold text-slate-400 uppercase text-[10px]">Cliente / Nombre</label>
                    <input type="text" id="cliente" placeholder="Nombre del Cliente" class="w-full font-bold border-b border-gray-200 focus:border-blue-500 outline-none pb-1">
                </div>
                <div class="md:col-span-2 space-y-1">
                    <label class="font-bold text-slate-400 uppercase text-[10px]">DirecciÃ³n / Destino</label>
                    <input type="text" id="direccion" placeholder="DirecciÃ³n de entrega" class="w-full font-bold border-b border-gray-200 focus:border-blue-500 outline-none pb-1">
                </div>
            </div>
        </div>

        <div class="p-6 bg-slate-50 border-b border-gray-200 no-print">
            <div class="flex gap-4">
                <div class="relative flex-1">
                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"></i>
                    <input type="text" id="searchInput" placeholder="Filtrar por Fardo especÃ­fico o POA..." 
                        class="w-full pl-10 pr-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <button onclick="cargarInventario()" class="bg-blue-900 text-white px-8 py-3 rounded-xl font-bold hover:bg-blue-800 transition-all flex items-center gap-2">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i> ACTUALIZAR
                </button>
            </div>
            <p id="status" class="text-xs mt-2 text-slate-500"></p>
        </div>

        <div class="p-0 overflow-x-auto">
            <table id="packingTable" class="w-full text-[11px] text-center border-collapse">
                <thead>
                    <tr class="text-slate-900 uppercase tracking-tighter border-y-2 border-slate-900 bg-slate-100">
                        <th class="p-2 border border-slate-300 no-print">âœ”</th>
                        <th class="p-2 border border-slate-300">Item</th>
                        <th class="p-2 border border-slate-300">Fardo</th>
                        <th class="p-2 border border-slate-300">Especie</th>
                        <th class="p-2 border border-slate-300">Calidad</th>
                        <th class="p-2 border border-slate-300">CondiciÃ³n</th>
                        <th class="p-2 border border-slate-300">Grosor</th>
                        <th class="p-2 border border-slate-300">Largo</th>
                        <th class="p-2 border border-slate-300">Piezas</th>
                        <th class="p-2 border border-slate-300">PT</th>
                        <th class="p-2 border border-slate-300">M3</th>
                    </tr>
                </thead>
                <tbody id="tableBody" class="font-mono text-slate-700">
                    <!-- Filas generadas dinÃ¡micamente -->
                </tbody>
                <tfoot id="tableFoot" class="bg-slate-100 font-bold border-t-2 border-slate-900">
                    <!-- Totales -->
                </tfoot>
            </table>
        </div>

        <div class="p-8 bg-slate-50 flex justify-between items-center no-print">
            <div class="text-slate-500 text-sm">
                * Seleccione los fardos para generar el reporte o dar de baja.
            </div>
            <button onclick="rebajarInventario()" class="bg-red-600 hover:bg-red-700 text-white px-10 py-4 rounded-2xl font-black text-lg shadow-xl shadow-red-600/20 transition-all flex items-center gap-3">
                <i data-lucide="trash-2"></i> DAR DE BAJA (SALIDA)
            </button>
        </div>
    </div>

    <script>
        lucide.createIcons();
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyJm67IZXi_zHsxQv3mqosqb6-RyKp4-j-h-kqdP153HTN8t6lt7BPE5BrwSzphArkx/exec";
        let inventarioCompleto = [];
        let fardosCargados = [];

        window.onload = () => {
            document.getElementById('fecha').value = new Date().toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            cargarInventario();
            // Escuchar cambios en los campos del encabezado para filtrar automÃ¡ticamente
            ['especie', 'calidad', 'headerGrosor', 'searchInput'].forEach(id => {
                document.getElementById(id).addEventListener('input', aplicarFiltros);
            });
        };

        // Helper para obtener valores de forma flexible
        function getVal(row, keys) {
            if (!row) return '';
            for (const k of keys) {
                if (row[k] !== undefined && row[k] !== null && row[k] !== "") return row[k];
            }
            const rowKeys = Object.keys(row);
            for (const k of keys) {
                const match = rowKeys.find(rk => rk.toLowerCase().trim() === k.toLowerCase().trim());
                if (match && row[match] !== undefined && row[match] !== "") return row[match];
            }
            return '';
        }

        function formatThickness(v) {
            if (!v) return "";
            // Limpiar espacios y cualquier caracter no numÃ©rico/slash al final (ej: "4/4,")
            let s = String(v).trim().replace(/[^0-9/]+$/g, '');
            
            // 1. Si ya es una fracciÃ³n (ej: "3/4"), la devolvemos tal cual (limpia)
            if (s.includes('/') && !s.includes('T')) {
                return s;
            }

            const val = parseFloat(s.replace(',', '.'));
            if (!isNaN(val)) {
                const epsilon = 0.01;
                if (Math.abs(val - 0.5) < epsilon) return "2/4";
                if (Math.abs(val - 0.75) < epsilon) return "3/4";
                if (Math.abs(val - 1.0) < epsilon) return "4/4";
                if (Math.abs(val - 1.25) < epsilon) return "5/4";
                if (Math.abs(val - 1.5) < epsilon) return "6/4";
                if (Math.abs(val - 1.75) < epsilon) return "7/4";
                if (Math.abs(val - 2.0) < epsilon) return "8/4";
                if (Math.abs(val - 2.25) < epsilon) return "9/4";
                if (Math.abs(val - 2.5) < epsilon) return "10/4";
                if (Math.abs(val - 2.75) < epsilon) return "11/4";
                if (Math.abs(val - 3.0) < epsilon) return "12/4";
                if (Math.abs(val - 4.0) < epsilon) return "16/4";
                return val.toString();
            }
            // 2. Solo si no es un nÃºmero ni fracciÃ³n manual, revisar si es fecha de Sheets
            if (s.includes('T') && !isNaN(Date.parse(s))) {
                const d = new Date(s);
                return `${d.getDate()}/${d.getMonth() + 1}`;
            }
            return s;
        }

        function actualizarDatalists() {
            const fEspecie = document.getElementById('especie').value.toUpperCase().trim();
            const fCalidad = document.getElementById('calidad').value.toUpperCase().trim();
            const fGrosor = document.getElementById('headerGrosor').value.trim();

            const especies = new Set();
            const calidades = new Set();
            const grosores = new Set();

            inventarioCompleto.forEach(row => {
                const rowEspecie = String(getVal(row, ['ESPECIE', 'especie'])).toUpperCase();
                const rowCalidad = String(getVal(row, ['CALIDAD', 'calidad'])).toUpperCase();
                const rowGrosor = formatThickness(getVal(row, ['GROSOR', 'grosor']));

                // Para la lista de especies: debe cumplir con Calidad y Grosor actuales
                let matchEsp = true;
                if (fCalidad && !rowCalidad.includes(fCalidad)) matchEsp = false;
                if (fGrosor && !rowGrosor.includes(fGrosor)) matchEsp = false;
                if (matchEsp && rowEspecie && rowEspecie !== 'UNDEFINED') especies.add(rowEspecie);

                // Para la lista de calidades: debe cumplir con Especie y Grosor actuales
                let matchCal = true;
                if (fEspecie && !rowEspecie.includes(fEspecie)) matchCal = false;
                if (fGrosor && !rowGrosor.includes(fGrosor)) matchCal = false;
                if (matchCal && rowCalidad && rowCalidad !== 'UNDEFINED') calidades.add(rowCalidad);

                // Para la lista de grosores: debe cumplir con Especie y Calidad actuales
                let matchGro = true;
                if (fEspecie && !rowEspecie.includes(fEspecie)) matchGro = false;
                if (fCalidad && !rowCalidad.includes(fCalidad)) matchGro = false;
                if (matchGro && rowGrosor && rowGrosor !== 'UNDEFINED') grosores.add(rowGrosor);
            });

            llenarDatalist('listaEspecies', Array.from(especies).sort());
            llenarDatalist('listaCalidades', Array.from(calidades).sort());
            llenarDatalist('listaGrosores', Array.from(grosores).sort());
        }

        function llenarDatalist(id, items) {
            const dl = document.getElementById(id);
            dl.innerHTML = '';
            items.forEach(item => {
                const opt = document.createElement('option');
                opt.value = item;
                dl.appendChild(opt);
            });
        }

        async function cargarInventario() {
            const status = document.getElementById('status');
            status.innerText = "ðŸ”„ Conectando con Base de Datos...";
            try {
                const res = await fetch(`${SCRIPT_URL}?sheet=MADERA ASERRADA`);
                inventarioCompleto = await res.json();
                actualizarDatalists();
                status.innerText = "âœ… Datos listos. Use los campos de arriba para filtrar.";
                aplicarFiltros();
            } catch (e) {
                console.error(e);
                status.innerText = "âŒ Error al conectar con la base de datos.";
            }
        }

        function aplicarFiltros() {
            const fEspecie = document.getElementById('especie').value.toLowerCase().trim();
            const fCalidad = document.getElementById('calidad').value.toLowerCase().trim();
            const fGrosor = document.getElementById('headerGrosor').value.toLowerCase().trim();
            const fSearch = document.getElementById('searchInput').value.toLowerCase().trim();
            const status = document.getElementById('status');

            // Actualizar las listas de sugerencias basadas en los otros filtros seleccionados
            actualizarDatalists();

            if (!fEspecie && !fCalidad && !fGrosor && !fSearch) {
                fardosCargados = [];
                renderTabla();
                status.innerText = "ðŸ’¡ Ingrese Especie, Calidad o Grosor para ver resultados.";
                return;
            }
                
                // 1. Filtrar solo fardos verificados primero
                const verificados = inventarioCompleto.filter(row => {
                    const statusVerificado = String(getVal(row, ['VERIFICADO', 'Verificado'])).toUpperCase().trim();
                    return statusVerificado === 'SI';
                });

                const filtrados = verificados.filter(row => {
                    const rowEspecie = String(getVal(row, ['ESPECIE', 'especie'])).toLowerCase().trim();
                    const rowCalidad = String(getVal(row, ['CALIDAD', 'calidad'])).toLowerCase().trim();
                    const rawGrosor = String(getVal(row, ['GROSOR', 'grosor'])).toLowerCase().trim();
                    const rowGrosorFmt = formatThickness(rawGrosor).toLowerCase().trim();
                    const rowFardo = String(getVal(row, ['FARDO', 'fardo', 'bulto'])).toLowerCase().trim();
                    const rowPoa = String(getVal(row, ['POA', 'poa'])).toLowerCase().trim();

                    // Filtros de encabezado (AND entre campos, OR dentro de cada campo si hay comas)
                    if (fEspecie) {
                        const especieTerms = fEspecie.split(',').map(s => s.trim()).filter(s => s);
                        if (!especieTerms.some(term => rowEspecie === term)) return false;
                    }
                    if (fCalidad) {
                        const calidadTerms = fCalidad.split(',').map(s => s.trim()).filter(s => s);
                        if (!calidadTerms.some(term => rowCalidad === term)) return false;
                    }
                    if (fGrosor) {
                        const grosorTerms = fGrosor.split(',').map(s => s.trim()).filter(s => s);
                        if (!grosorTerms.some(term => rowGrosorFmt === term)) return false;
                    }
                    
                    // Filtro de bÃºsqueda (Fardo o POA)
                    if (fSearch) {
                        const searchTerms = fSearch.split(',').map(s => s.trim()).filter(s => s);
                        const matchSearch = searchTerms.some(term => 
                            rowFardo === term || rowFardo.includes(term) || rowPoa.includes(term)
                        );
                        if (!matchSearch) return false;
                    }

                    return true;
                });

                // 2. Agrupar por Fardo
                const agrupados = {};
                filtrados.forEach(row => {
                    const fardoId = getVal(row, ['FARDO', 'fardo', 'bulto']);
                    if (!fardoId) return;

                    if (!agrupados[fardoId]) {
                        agrupados[fardoId] = {
                            FARDO: fardoId,
                            ESPECIE: String(getVal(row, ['ESPECIE', 'especie'])).toUpperCase(),
                            CALIDAD: String(getVal(row, ['CALIDAD', 'calidad'])).toUpperCase(),
                            CONDICION: String(getVal(row, ['CONDICION', 'condicion'])).toUpperCase(),
                            GROSOR: getVal(row, ['GROSOR', 'grosor']),
                            ANCHO: getVal(row, ['ANCHO', 'ancho']),
                            largos: new Set(),
                            PIEZAS: 0,
                            PT: 0
                        };
                    }
                    
                    // Sumar
                    agrupados[fardoId].PIEZAS += parseInt(getVal(row, ['PIEZAS', 'piezas'])) || 0;
                    agrupados[fardoId].PT += parseFloat(getVal(row, ['PIES TABLARES', 'pt', 'PT'])) || 0;
                    
                    // Recolectar largos para rango
                    const l = parseFloat(getVal(row, ['LARGO', 'largo']));
                    if (!isNaN(l)) agrupados[fardoId].largos.add(l);
                });

                 fardosCargados = Object.values(agrupados).map(f => {
                    const ls = Array.from(f.largos).sort((a, b) => a - b);
                    f.LARGO = ls.length > 1 ? `${ls[0]}-${ls[ls.length - 1]}` : (ls[0] || "");
                    f.M3 = Math.round(f.PT) / 424;
                    return f;
                });

                // 3. Ordenar por Fardo
                fardosCargados.sort((a, b) => {
                    const fa = parseInt(getVal(a, ['FARDO', 'fardo'])) || 0;
                    const fb = parseInt(getVal(b, ['FARDO', 'fardo'])) || 0;
                    return fa - fb;
                });

                renderTabla();
                
                status.innerText = fardosCargados.length > 0 
                    ? `âœ… Mostrando ${fardosCargados.length} fardos filtrados.` 
                    : "âš ï¸ No hay coincidencias con los filtros actuales.";
        }

        function renderTabla() {
            const body = document.getElementById('tableBody');
            body.innerHTML = '';

            fardosCargados.forEach((f, index) => {
                const fardoId = getVal(f, ['FARDO', 'fardo']);
                const especie = String(getVal(f, ['ESPECIE', 'especie'])).toUpperCase();
                const calidad = String(getVal(f, ['CALIDAD', 'calidad'])).toUpperCase();
                const condicion = String(getVal(f, ['CONDICION', 'condicion'])).toUpperCase();
                const grosor = formatThickness(getVal(f, ['GROSOR', 'grosor']));
                const largo = getVal(f, ['LARGO', 'largo']);
                const piezas = parseInt(getVal(f, ['PIEZAS', 'piezas'])) || 0;
                const pt = parseFloat(getVal(f, ['PIES TABLARES', 'pt', 'PT'])) || 0;
                const m3 = Math.round(pt) / 424;

                const row = document.createElement('tr');
                row.className = "border-b border-gray-100 hover:bg-blue-50 transition-colors";
                row.innerHTML = `
                    <td class="p-2 border no-print"><input type="checkbox" checked class="w-4 h-4 fardo-check" data-index="${index}"></td>
                    <td class="p-2 border text-slate-400">${index + 1}</td>
                    <td class="p-2 border font-bold text-blue-900">${fardoId}</td>
                    <td class="p-2 border">${especie}</td>
                    <td class="p-2 border">${calidad}</td>
                    <td class="p-2 border">${condicion}</td>
                    <td class="p-2 border">${grosor}</td>
                    <td class="p-2 border">${largo}'</td>
                    <td class="p-2 border">${piezas}</td>
                    <td class="p-2 border font-bold">${Math.round(pt)}</td>
                    <td class="p-2 border">${m3.toFixed(2)}</td>
                `;
                body.appendChild(row);
            });
            actualizarTotales();
        }

        function actualizarTotales() {
            const checkboxes = document.querySelectorAll('.fardo-check:checked');
            let tPiezas = 0;
            let tPT = 0;
            let fardosUnicos = new Set();

            checkboxes.forEach(cb => {
                const index = parseInt(cb.dataset.index);
                const f = fardosCargados[index];
                if (!f) return;

                const fardoId = getVal(f, ['FARDO', 'fardo']);
                fardosUnicos.add(fardoId);

                const piezas = parseInt(getVal(f, ['PIEZAS', 'piezas'])) || 0;
                const pt = parseFloat(getVal(f, ['PIES TABLARES', 'pt', 'PT'])) || 0;

                tPiezas += piezas;
                tPT += Math.round(pt);
            });

            const tM3 = tPT / 424;

            const foot = document.getElementById('tableFoot');
            foot.innerHTML = `
                <tr class="text-slate-900 uppercase text-[11px]">
                    <td class="p-3 border no-print"></td>
                    <td class="p-3 border font-black text-center">${fardosUnicos.size}</td>
                    <td colspan="6" class="p-3 border text-right font-black text-slate-500">TOTALES:</td>
                    <td class="p-3 border font-black bg-blue-50">${tPiezas}</td>
                    <td class="p-3 border font-black bg-blue-100 text-blue-900 text-sm">${tPT}</td>
                    <td class="p-3 border font-black bg-blue-50">${tM3.toFixed(2)}</td>
                </tr>
            `;
        }

        document.getElementById('tableBody').addEventListener('change', function(e) {
            if(e.target.classList.contains('fardo-check')) {
                actualizarTotales();
            }
        });

        async function rebajarInventario() {
            const seleccionados = document.querySelectorAll('.fardo-check:checked');
            if (seleccionados.length === 0) return alert("Seleccione al menos un fardo.");
            
            const motivo = prompt("Ingrese el MOTIVO de la salida (Ej: Venta Local, ExportaciÃ³n, Merma):", "Venta");
            if (!motivo) return;

            // Obtener lista Ãºnica de fardos seleccionados
            const fardosSet = new Set();
            seleccionados.forEach(cb => {
                const index = parseInt(cb.dataset.index);
                const f = fardosCargados[index];
                const fardoId = getVal(f, ['FARDO', 'fardo']);
                if(fardoId) fardosSet.add(fardoId);
            });

            if (!confirm(`Â¿Desea dar de baja ${fardosSet.size} fardos con motivo: ${motivo}?`)) return;

            // OpciÃ³n de seguridad: Descargar Excel antes de que desaparezcan los datos
            if (confirm("Â¿Desea descargar el documento (Excel) antes de procesar la baja?")) {
                try {
                    await exportarExcel();
                } catch (e) {
                    if (!confirm("OcurriÃ³ un error al generar el Excel. Â¿Desea continuar con la baja de todos modos?")) return;
                }
            }

            const btn = document.querySelector('button[onclick="rebajarInventario()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin"></i> Procesando...';
            btn.disabled = true;
            lucide.createIcons();

            let successCount = 0;
            let errorCount = 0;

            // Procesar uno por uno (para evitar timeouts o complejidad en backend si no soporta bulk)
            for (const fardoId of fardosSet) {
                try {
                    const payload = { 
                        tipo: "baja_aserrada", 
                        bulto: fardoId,
                        sheetName: "MADERA ASERRADA", 
                        targetSheet: "SALIDA MDA", 
                        motivo: motivo 
                    };

                    const res = await fetch(SCRIPT_URL, {
                        method: "POST",
                        body: JSON.stringify(payload)
                    });
                    const data = await res.json();
                    
                    if (data.result === "success") successCount++;
                    else {
                        console.error(`Error fardo ${fardoId}:`, data.message);
                        errorCount++;
                    }
                } catch (e) {
                    console.error(`ExcepciÃ³n fardo ${fardoId}:`, e);
                    errorCount++;
                }
            }

            alert(`Proceso finalizado.\nâœ… Exitosos: ${successCount}\nâŒ Fallidos: ${errorCount}`);
            btn.innerHTML = originalText;
            btn.disabled = false;
            lucide.createIcons();
            
            // Refrescar tabla
            buscarFardos();
        }

        async function exportarExcel() {
            if (typeof ExcelJS === 'undefined') {
                alert("Error: La librerÃ­a ExcelJS no se cargÃ³. Revise su conexiÃ³n.");
                return;
            }

            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet('Packing List Aserrada');

            // ConfiguraciÃ³n de pÃ¡gina para impresiÃ³n en Carta
            worksheet.pageSetup = {
                paperSize: 1, // Letter
                orientation: 'portrait',
                fitToPage: true,
                fitToWidth: 1,
                fitToHeight: 0
            };

            const checkboxes = document.querySelectorAll('.fardo-check:checked');
            if (checkboxes.length === 0) return alert("âš ï¸ No hay fardos seleccionados para exportar.");

            // Logo y Encabezado
            try {
                const response = await fetch('logo-giborv2 (2).png');
                const blob = await response.blob();
                const arrayBuffer = await blob.arrayBuffer();
                const imageId = workbook.addImage({
                    buffer: arrayBuffer,
                    extension: 'png',
                });
                worksheet.addImage(imageId, {
                    tl: { col: 0, row: 0 },
                    ext: { width: 160, height: 80 }, // TamaÃ±o fijo para evitar deformaciÃ³n
                    editAs: 'absolute'
                });
            } catch (e) { console.warn("Logo no cargado"); }

            // Metadatos
            const tipoDoc = document.getElementById('tipoDocumento').value;
            const metaStyle = { font: { bold: true } };
            
            worksheet.getCell('A6').value = "Fecha: " + document.getElementById('fecha').value;
            worksheet.getCell('A6').font = metaStyle;

            if (tipoDoc === 'cliente' || tipoDoc === 'gerencial') {
                if (tipoDoc === 'gerencial') {
                    worksheet.getCell('A5').value = "Producto: " + document.getElementById('producto').value;
                    worksheet.getCell('A5').font = metaStyle;
                    worksheet.getCell('A6').value = "Especie: " + document.getElementById('especie').value;
                    worksheet.getCell('A6').font = metaStyle;
                    worksheet.getCell('A7').value = "Calidad: " + document.getElementById('calidad').value;
                    worksheet.getCell('A7').font = metaStyle;
                    worksheet.getCell('A8').value = "Nombre: " + document.getElementById('cliente').value;
                    worksheet.getCell('A8').font = metaStyle;
                    worksheet.getCell('A9').value = "Direccion: " + document.getElementById('direccion').value;
                    worksheet.getCell('A9').font = metaStyle;
                    worksheet.getCell('A10').value = "Fecha: " + document.getElementById('fecha').value;
                    worksheet.getCell('A10').font = metaStyle;
                } else {
                    worksheet.getCell('A7').value = "Cliente: " + document.getElementById('cliente').value;
                    worksheet.getCell('A8').value = "DirecciÃ³n: " + document.getElementById('direccion').value;
                    ['A7', 'A8'].forEach(c => worksheet.getCell(c).font = metaStyle);
                }
            } else {
                // ORDEN DE DESPACHO (B7 a H7 en Grande)
                worksheet.mergeCells('B7:H7');
                const titleCell = worksheet.getCell('B7');
                titleCell.value = "ORDEN DE DESPACHO";
                titleCell.font = { bold: true, size: 20, name: 'Arial Black' };
                titleCell.alignment = { horizontal: 'center', vertical: 'middle' };
            }

            // Encabezados de tabla
            let headers, startRow;
            if (tipoDoc === 'gerencial') {
                headers = ["#", "Fardo", "Grosor", "Largo", "Piezas", "PT", "M3", "Calidad", "CondiciÃ³n"];
                startRow = 12;
            } else {
                headers = ["Item", "Fardo", "Especie", "Calidad", "CondiciÃ³n", "Grosor", "Largo", "Piezas", "PT", "M3"];
                startRow = 11;
            }
            
            const headerRow = worksheet.getRow(startRow);
            headerRow.values = headers;
            headerRow.height = 30;
            headerRow.font = { bold: true, color: { argb: 'FF000000' } };
            headerRow.eachCell(cell => {
                cell.alignment = { horizontal: 'center', vertical: 'middle' };
                cell.border = {
                    top: {style:'thin'},
                    left: {style:'thin'},
                    bottom: {style:'thin'},
                    right: {style:'thin'}
                };
            });

            let tPzs = 0, tPT = 0;

            checkboxes.forEach((cb, i) => {
                const index = parseInt(cb.dataset.index);
                const f = fardosCargados[index];
                
                const fardoId = getVal(f, ['FARDO', 'fardo']);
                const piezas = parseInt(getVal(f, ['PIEZAS', 'piezas'])) || 0;
                const ptRaw = parseFloat(getVal(f, ['PIES TABLARES', 'pt', 'PT'])) || 0;
                const pt = Math.round(ptRaw);
                const m3 = pt / 424;

                tPzs += piezas;
                tPT += pt;

                let rowData;
                if (tipoDoc === 'gerencial') {
                    rowData = [
                        1,
                        fardoId,
                        formatThickness(getVal(f, ['GROSOR', 'grosor'])),
                        getVal(f, ['LARGO', 'largo']),
                        piezas,
                        pt,
                        parseFloat(m3.toFixed(2)),
                        String(getVal(f, ['CALIDAD', 'calidad'])).toUpperCase(),
                        String(getVal(f, ['CONDICION', 'condicion'])).toUpperCase()
                    ];
                } else {
                    rowData = [
                        1,
                        fardoId,
                        String(getVal(f, ['ESPECIE', 'especie'])).toUpperCase(),
                        String(getVal(f, ['CALIDAD', 'calidad'])).toUpperCase(),
                        String(getVal(f, ['CONDICION', 'condicion'])).toUpperCase(),
                        formatThickness(getVal(f, ['GROSOR', 'grosor'])),
                        getVal(f, ['LARGO', 'largo']),
                        piezas,
                        pt,
                        parseFloat(m3.toFixed(2))
                    ];
                }

                const row = worksheet.addRow(rowData);
                
                row.eachCell(cell => {
                    cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
                    cell.alignment = { horizontal: 'center' };
                });
            });

            const tM3 = tPT / 424;

            // Totales
            let totalRow;
            if (tipoDoc === 'gerencial') {
                totalRow = worksheet.addRow([checkboxes.length, '', '', '', tPzs, tPT, parseFloat(tM3.toFixed(2)), '', '']);
            } else {
                totalRow = worksheet.addRow([checkboxes.length, 'TOTALES', '', '', '', '', '', tPzs, tPT, parseFloat(tM3.toFixed(2))]);
            }
            totalRow.font = { bold: true };
            totalRow.eachCell(cell => {
                cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
                cell.alignment = { horizontal: 'center' };
            });

            // Ajustar anchos
            let columnWidths;
            if (tipoDoc === 'gerencial') {
                columnWidths = [6, 10, 8, 10, 8, 12, 12, 25, 12];
            } else {
                columnWidths = [6, 10, 25, 25, 12, 8, 10, 8, 12, 12];
            }
            columnWidths.forEach((w, i) => {
                worksheet.getColumn(i + 1).width = w;
            });

            // --- NUEVA PESTAÃ‘A: TALLYS (DESGLOSE DETALLADO) ---
            const tallySheet = workbook.addWorksheet('TALLY');
            const tallyHeaders = ["#Fardo", "Grosor", "Largo", "Ancho", "PT", "Cantidad", "CondiciÃ³n", "CALIDAD", "Especie"];
            const tallyHeaderRow = tallySheet.getRow(1);
            tallyHeaderRow.values = tallyHeaders;
            tallyHeaderRow.font = { bold: true };
            tallyHeaderRow.eachCell(cell => {
                cell.alignment = { horizontal: 'center' };
                cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
            });

            const selectedFardoIds = Array.from(checkboxes).map(cb => {
                const index = parseInt(cb.dataset.index);
                return String(getVal(fardosCargados[index], ['FARDO', 'fardo']));
            });

            // Filtrar las filas originales de inventarioCompleto que pertenecen a los fardos seleccionados
            const tallyRows = inventarioCompleto.filter(row => {
                const fId = String(getVal(row, ['FARDO', 'fardo', 'bulto']));
                return selectedFardoIds.includes(fId);
            });

            // Ordenar por fardo, luego ancho, luego largo para que sea fÃ¡cil de leer
            tallyRows.sort((a, b) => {
                const fa = parseInt(getVal(a, ['FARDO', 'fardo'])) || 0;
                const fb = parseInt(getVal(b, ['FARDO', 'fardo'])) || 0;
                if (fa !== fb) return fa - fb;
                const aa = parseFloat(getVal(a, ['ANCHO', 'ancho'])) || 0;
                const ab = parseFloat(getVal(b, ['ANCHO', 'ancho'])) || 0;
                if (aa !== ab) return aa - ab;
                return (parseFloat(getVal(a, ['LARGO', 'largo'])) || 0) - (parseFloat(getVal(b, ['LARGO', 'largo'])) || 0);
            });

            tallyRows.forEach(row => {
                const r = tallySheet.addRow([
                    getVal(row, ['FARDO', 'fardo']),
                    formatThickness(getVal(row, ['GROSOR', 'grosor'])),
                    getVal(row, ['LARGO', 'largo']),
                    getVal(row, ['ANCHO', 'ancho']),
                    parseFloat(getVal(row, ['PIES TABLARES', 'pt', 'PT'])) || 0,
                    parseInt(getVal(row, ['PIEZAS', 'piezas'])) || 0,
                    String(getVal(row, ['CONDICION', 'condicion'])).toUpperCase(),
                    String(getVal(row, ['CALIDAD', 'calidad'])).toUpperCase(),
                    String(getVal(row, ['ESPECIE', 'especie'])).toUpperCase()
                ]);
                r.eachCell(cell => {
                    cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
                    cell.alignment = { horizontal: 'center' };
                });
            });

            tallySheet.columns.forEach(col => { col.width = 15; });

            const buffer = await workbook.xlsx.writeBuffer();
            saveAs(new Blob([buffer]), `Packing_Aserrada_${document.getElementById('cliente').value || 'Cliente'}.xlsx`);
        }
    </script>
</body>
</html>