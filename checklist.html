<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checklist - Producto Terminado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4 md:p-8">
    <div class="max-w-4xl mx-auto">
        <a href="index.html" class="inline-flex items-center gap-2 text-slate-500 hover:text-blue-600 transition-colors mb-6 font-medium">
            <i data-lucide="arrow-left" class="w-4 h-4"></i> Volver al Dashboard
        </a>

        <div class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
            <div>
                <h1 class="text-2xl font-bold text-slate-800">Checklist de Salida (PTE)</h1>
                <p class="text-slate-500 text-sm">Selecciona los fardos para mover a SALIDA PTE.</p>
            </div>
            <div class="flex gap-2">
                <button onclick="rebajarSeleccionados()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-red-600/20 transition-all flex items-center gap-2 active:scale-95">
                    <i data-lucide="package-minus" class="w-5 h-5"></i> Rebajar Seleccionados
                </button>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="p-4 border-b border-slate-100 bg-slate-50/50 flex gap-4">
                <div class="relative flex-1">
                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                    <input type="text" id="search" placeholder="Buscar por Lote o Fardo..." class="w-full pl-10 pr-4 py-2 rounded-xl border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none transition-all text-sm" oninput="filterTable()">
                </div>
                <button onclick="cargarDatos()" class="p-2 text-slate-600 hover:bg-slate-200 rounded-lg transition-colors">
                    <i data-lucide="refresh-cw" class="w-5 h-5" id="refresh-icon"></i>
                </button>
            </div>

            <div class="overflow-x-auto custom-scrollbar">
                <table class="w-full text-sm text-left">
                    <thead class="bg-slate-50 text-slate-500 font-bold uppercase tracking-wider text-[10px] border-b border-slate-100">
                        <tr>
                            <th class="px-6 py-4 w-10">
                                <input type="checkbox" id="select-all" onclick="toggleAll(this)" class="rounded border-slate-300 text-blue-600 focus:ring-blue-500 w-4 h-4">
                            </th>
                            <th class="px-6 py-4">Lote / Fardo</th>
                            <th class="px-6 py-4">Producto / Especie</th>
                            <th class="px-6 py-4 text-right">Medida</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-slate-100">
                        <tr>
                            <td colspan="4" class="px-6 py-12 text-center text-slate-400 italic">Cargando inventario remoto...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyJm67IZXi_zHsxQv3mqosqb6-RyKp4-j-h-kqdP153HTN8t6lt7BPE5BrwSzphArkx/exec";
        let inventario = [];

        async function cargarDatos() {
            const icon = document.getElementById('refresh-icon');
            icon.classList.add('animate-spin');
            
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL + "?sheet=PRODUCTO TERMINADO");
                inventario = await response.json();
                renderTable(inventario);
            } catch (e) {
                console.error(e);
                document.getElementById('table-body').innerHTML = '<tr><td colspan="4" class="px-6 py-12 text-center text-red-500">Error al conectar con la base de datos</td></tr>';
            } finally {
                icon.classList.remove('animate-spin');
            }
        }

        function renderTable(data) {
            const tbody = document.getElementById('table-body');
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-12 text-center text-slate-400">No hay fardos en Producto Terminado</td></tr>';
                return;
            }

            tbody.innerHTML = data.map((f, index) => `
                <tr class="hover:bg-slate-50 transition-colors group">
                    <td class="px-6 py-4">
                        <input type="checkbox" class="fardo-checkbox rounded border-slate-300 text-blue-600 focus:ring-blue-500 w-4 h-4" 
                            data-lote="${f['# Lote'] || f['Lote'] || ''}" 
                            data-fardo="${f['# Fardo'] || f['fardoNo'] || ''}">
                    </td>
                    <td class="px-6 py-4">
                        <div class="font-bold text-slate-700">Lote: ${f['# Lote'] || f['Lote'] || '---'}</div>
                        <div class="text-xs text-slate-400">Fardo: ${f['# Fardo'] || f['fardoNo'] || '---'}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-slate-600 font-medium">${f['Producto'] || f['producto'] || '---'}</div>
                        <div class="text-xs text-slate-400">${f['Especie'] || f['especie'] || '---'}</div>
                    </td>
                    <td class="px-6 py-4 text-right font-mono font-bold text-blue-600">
                        ${(parseFloat(f['M2'] || f['m2'] || f['ML'] || f['ml'] || 0)).toFixed(2)}
                    </td>
                </tr>
            `).join('');
        }

        function filterTable() {
            const term = document.getElementById('search').value.toLowerCase();
            const filtered = inventario.filter(f => 
                String(f['# Lote'] || '').toLowerCase().includes(term) || 
                String(f['# Fardo'] || '').toLowerCase().includes(term) ||
                String(f['Producto'] || '').toLowerCase().includes(term)
            );
            renderTable(filtered);
        }

        function toggleAll(source) {
            const checkboxes = document.querySelectorAll('.fardo-checkbox');
            checkboxes.forEach(cb => cb.checked = source.checked);
        }

        async function rebajarSeleccionados() {
            const selected = document.querySelectorAll('.fardo-checkbox:checked');
            if (selected.length === 0) return alert("⚠️ Selecciona al menos un fardo.");

            const motivo = prompt(`¿Motivo de salida para ${selected.length} fardos?`, "Venta");
            if (motivo === null) return;
            if (motivo.trim() === "") return alert("❌ El motivo es obligatorio.");

            if (!confirm(`¿Confirmas que deseas mover ${selected.length} fardos a SALIDA PTE?`)) return;

            const items = Array.from(selected).map(cb => ({
                lote: cb.dataset.lote,
                fardo: cb.dataset.fardo
            }));
            
            let exitos = 0;
            let errores = 0;

            // Procesamos uno por uno para asegurar que el script de Google los mueva correctamente
            for (const item of items) {
                const payload = {
                    tipo: "baja_pte", // Asegúrate que tu Google Script maneje este 'tipo'
                    lote: item.lote,
                    fardo: item.fardo,
                    sheetName: "PRODUCTO TERMINADO",
                    targetSheet: "SALIDA PTE",
                    motivo: motivo
                };

                try {
                    const response = await fetch(GOOGLE_SCRIPT_URL, {
                        method: "POST",
                        body: JSON.stringify(payload)
                    });
                    const res = await response.json();
                    if (res.result === "success") exitos++;
                    else errores++;
                } catch (e) {
                    console.error("Error en fardo " + item.fardo, e);
                    errores++;
                }
            }

            alert(`✅ Proceso finalizado.\n\nÉxitos: ${exitos}\nErrores: ${errores}`);
            cargarDatos(); // Recargar tabla
        }

        window.onload = () => {
            lucide.createIcons();
            cargarDatos();
        };
    </script>
</body>
</html>