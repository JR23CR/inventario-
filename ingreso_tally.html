<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ingreso de Tallys - Madera Aserrada</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsbarcode/3.11.5/JsBarcode.all.min.js"></script>
    <script src="formato_etiqueta_producto_terminado.js"></script>

    <style>
        :root {
            --primary: #1e293b;
            --accent: #3b82f6;
            --success: #22c55e;
            --bg: #f8fafc;
            --card-bg: #FFFFFF;
            --text-main: #0f172a;
            --border: #e2e8f0;
        }
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 0;
            color: var(--text-main);
        }
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }

        .top-bar {
            background: var(--primary);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .top-bar h2 { margin: 0; font-size: 1.2rem; letter-spacing: 1px; }
        #btStatus { font-size: 0.8rem; opacity: 0.8; }

        .card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border);
            margin-bottom: 24px;
        }
        .card h3 { 
            margin-top: 0; 
            font-size: 0.85rem; 
            color: var(--accent); 
            text-transform: uppercase; 
            border-bottom: 1px solid var(--border); 
            padding-bottom: 10px; 
            margin-bottom: 15px; 
            letter-spacing: 0.5px;
        }

        label { display: block; margin-top: 10px; font-weight: 600; font-size: 0.75rem; color: #64748b; text-transform: uppercase; }
        input, select {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid var(--border);
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 0.9rem;
            outline: none;
            transition: border-color 0.2s;
        }
        input:focus { border-color: var(--accent); }

        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        button:active { transform: translateY(1px); }
        .btn-main { background-color: var(--accent); color: white; }
        .btn-main:hover { background-color: #2563eb; }
        .btn-secondary { background-color: #64748b; color: white; }
        .btn-bt { background-color: #f59e0b; color: white; width: auto; padding: 8px 16px; }

        .table-container {
            max-height: 500px;
            overflow: auto;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: white;
        }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        thead th { position: sticky; top: 0; background: #f1f5f9; z-index: 10; padding: 10px; border: 1px solid var(--border); }
        tbody th { position: sticky; left: 0; background: #f1f5f9; z-index: 5; padding: 10px; border: 1px solid var(--border); }
        td { border: 1px solid var(--border); padding: 2px; }
        td input { width: 100%; border: none; text-align: center; padding: 8px 0; background: transparent; }
        td input:focus { background: #dbeafe; }
        tr:hover td { background: #f8fafc; }
        .total-col { background: #f1f5f9; font-weight: bold; }

        .actions-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 20px; }

        /* Estilos para Impresi√≥n PC */
        #printable-area { display: none; }
        @media print {
            @page { size: 4in 3in; margin: 0; }
            body * { visibility: hidden; }
            #printable-area, #printable-area * { visibility: visible; }
            #printable-area { position: absolute; left: 0; top: 0; width: 4in; height: 3in; display: block !important; }
            .label-page { width: 4in; height: 3in; padding: 10px; box-sizing: border-box; display: flex; flex-direction: column; align-items: center; text-align: center; }
            .lbl-header { display: flex; justify-content: space-between; width: 100%; border-bottom: 2px solid black; padding-bottom: 5px; }
            .lbl-title { font-size: 1rem; font-weight: bold; }
            .lbl-sub { font-size: 1.8rem; font-weight: 900; }
            .lbl-main { flex: 1; display: flex; flex-direction: column; justify-content: center; width: 100%; }
            .lbl-row { font-size: 0.9rem; margin: 2px 0; }
            .lbl-dims { font-size: 1.2rem; font-weight: bold; border-top: 1px solid black; margin-top: 5px; padding-top: 5px; }
            .lbl-footer { display: flex; width: 100%; border-top: 2px solid black; padding-top: 5px; }
            .lbl-col-print { flex: 1; }
            .lbl-head { font-size: 0.7rem; font-weight: bold; }
            .lbl-val { font-size: 1.3rem; font-weight: bold; }
        }
    </style>
</head>
<body>

<div class="top-bar no-print">
    <h2>GIBOR | Ingreso de Tallys</h2>
    <div style="display: flex; align-items: center; gap: 15px;">
        <div id="btStatus">Desconectado</div>
        <button class="btn-bt" onclick="conectarBluetooth()">üì° Conectar</button>
    </div>
</div>

<div class="container">
    <div class="grid-3 no-print" style="grid-template-columns: 2fr 1fr;">
        <div class="card col-span-2">
            <h3>1. Configuraci√≥n del Bulto</h3>
            <div class="grid-3">
                <div>
                    <label>Fecha</label>
                    <input type="date" id="fecha">
                </div>
                <div>
                    <label>POA</label>
                    <input type="text" id="poa" placeholder="Ej: 123-ABC">
                </div>
                <div>
                    <label>No. Bulto</label>
                    <input type="number" id="bultoNo" placeholder="Ej: 501">
                </div>
            </div>
            <div class="grid-3">
                <div>
                    <label>Especie</label>
                    <select id="especie"></select>
                </div>
                <div>
                    <label>Calidad</label>
                    <select id="calidad"></select>
                </div>
                <div>
                    <label>Espesor</label>
                    <select id="espesor">
                        <option value="1">4/4</option>
                        <option value="1.25">5/4</option>
                        <option value="1.5">6/4</option>
                        <option value="2">8/4</option>
                    </select>
                </div>
            </div>
            <div class="grid-2">
                <div>
                    <label>Condici√≥n</label>
                    <select id="condicion">
                        <option value="A-D" selected>A-D</option>
                        <option value="K-D">K-D</option>
                    </select>
                </div>
                <div>
                    <label>Ubicaci√≥n</label>
                    <input type="text" id="ubicacion" placeholder="Ej: Patio 1">
                </div>
            </div>
        </div>

        <div class="card">
            <h3>2. Herramientas</h3>
            <button class="btn-secondary" onclick="document.getElementById('excelFile').click()" style="background-color: #10b981; margin-bottom: 15px;">üìÇ Importar Excel</button>
            <input type="file" id="excelFile" accept=".xlsx, .xls, .csv" style="display: none;" onchange="procesarExcel(event)">
            <div id="importStatus" style="font-size: 0.7rem; color: #64748b;"></div>
            
            <div style="margin-top: 20px; border-top: 1px solid var(--border); padding-top: 10px;">
                <label>Rango de Largos</label>
                <div class="grid-2">
                    <input type="number" id="largoMin" placeholder="Min" oninput="generarTabla()">
                    <input type="number" id="largoMax" placeholder="Max" oninput="generarTabla()">
                </div>
                <button class="btn-main" onclick="generarTabla(true)" style="margin-top: 10px;">Generar Tabla</button>
            </div>
        </div>
    </div>

    <div class="card">
        <h3>3. Detalle de Piezas (Tally)</h3>
        <div class="table-container">
            <table id="tallyTable">
                <thead></thead>
                <tbody></tbody>
                <tfoot></tfoot>
            </table>
        </div>

        <div class="actions-bar no-print">
            <button class="btn-secondary" onclick="exportarCSV()">üì• Exportar CSV</button>
            <button class="btn-secondary" onclick="imprimirEtiquetaPC()" style="background-color: #0d9488;">üñ•Ô∏è Imprimir PC</button>
            <button class="btn-secondary" onclick="imprimirEtiquetaActual()" style="background-color: #d97706;">üì° Imprimir BT</button>
            <button class="btn-main" onclick="guardarTally()" style="background-color: #2563eb; font-size: 1.1rem;">üíæ GUARDAR EN NUBE</button>
        </div>
    </div>
</div>

<div id="printable-area"></div>

<script>
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyJm67IZXi_zHsxQv3mqosqb6-RyKp4-j-h-kqdP153HTN8t6lt7BPE5BrwSzphArkx/exec";
    let inventarioRemoto = [];
    let bluetoothDevice;
    let printCharacteristic;

    // Helper para obtener valores de un objeto (fila de Excel) de forma insensible a may√∫sculas y espacios
    const getVal = (row, keys) => {
        if (!row) return null;
        const rowKeys = Object.keys(row);
        for (const k of keys) {
            const match = rowKeys.find(rk => rk.toLowerCase().trim() === k.toLowerCase().trim());
            if (match !== undefined) return row[match];
        }
        return null;
    };

    const especiesList = [
        { nombre: "Maletio colorado", cientifico: "Aspidosperma megalocarpom", codigo: "ASPIME" },
        { nombre: "Maletio blanco", cientifico: "Aspidosperma stegomersis", codigo: "ASPISP" },
        { nombre: "Jobillo", cientifico: "Astronium graveolens", codigo: "ASTRGR" },
        { nombre: "Ramon oreja", cientifico: "Brosimum costaricanum", codigo: "BROSCO" },
        { nombre: "Pucte", cientifico: "Bucida buceras", codigo: "BUCIBU" },
        { nombre: "Chaltecoco", cientifico: "Caesalpinia velutina", codigo: "CAESVE" },
        { nombre: "Santa maria", cientifico: "Calophyllum brasiliense", codigo: "CALOBR" },
        { nombre: "Cedro", cientifico: "Cedrela odorata", codigo: "CEDROD" },
        { nombre: "Pochote", cientifico: "Bombacopsis spp.", codigo: "CEIBAE" },
        { nombre: "Cericote", cientifico: "Cordia dodecandra", codigo: "CORDDO" },
        { nombre: "Manchiche", cientifico: "Lonchocarpus castillo", codigo: "LONCCA" },
        { nombre: "Tzalam", cientifico: "Lysiloma bahamensis", codigo: "LYSIBA" },
        { nombre: "Chechen negro", cientifico: "Metopium brownei", codigo: "METOBR" },
        { nombre: "Jabin", cientifico: "Piscidia piscipula", codigo: "PISCPI" },
        { nombre: "Cola de coche", cientifico: "Pithecellobium arboreum", codigo: "PITHAR" },
        { nombre: "Hormigo", cientifico: "Platymiscium dimorphandrum", codigo: "PLATDI" },
        { nombre: "Granadillo", cientifico: "Platymiscium yucatanum", codigo: "PLATYU" },
        { nombre: "Rosul", cientifico: "Dalbergia tucurensis", codigo: "DALBTU" },
        { nombre: "Palo Blanco", cientifico: "Cybistax donnell-smithii", codigo: "CYBIDO" },
        { nombre: "Casta√±o", cientifico: "Sterculia apetala", codigo: "STERAP" },
        { nombre: "Guayac√°n", cientifico: "Guaiacum sanctum", codigo: "GUAISA" },
        { nombre: "Sili√≥n", cientifico: "Pouteria amygdalina", codigo: "POUTAMY" },
        { nombre: "Amapola", cientifico: "Pseudobombax ellipticum", codigo: "PSEUEL" },
        { nombre: "Pasaque", cientifico: "Simaruba glauca", codigo: "SIMAGL" },
        { nombre: "Catalox", cientifico: "Swartzia lundellii", codigo: "SWARLU" },
        { nombre: "Chichipate", cientifico: "Sweetia panamensis", codigo: "SWEEPA" },
        { nombre: "Caoba", cientifico: "Swietenia macrophylla", codigo: "SWIEMA" },
        { nombre: "Danto", cientifico: "Vatairea lundellii", codigo: "VATALU" },
        { nombre: "Gesmo", cientifico: "Lysiloma spp.", codigo: "LYSIAC" }
    ];

    const calidadesList = [
        "SELECTA Y MEJOR", "COMUN 1", "COMUN 2", "COMUNES", 
        "COMUNES G-B", "COMUN B", "COMUN Y MEJOR", "M-R"
    ];

    window.onload = function() {
        document.getElementById('fecha').valueAsDate = new Date();
        cargarInventario();
        
        const selEspecie = document.getElementById('especie');
        especiesList.forEach(esp => {
            const opt = document.createElement('option');
            opt.value = esp.nombre;
            opt.text = esp.nombre;
            selEspecie.appendChild(opt);
        });

        const selCalidad = document.getElementById('calidad');
        calidadesList.forEach(cal => {
            const opt = document.createElement('option');
            opt.value = cal;
            opt.text = cal;
            selCalidad.appendChild(opt);
        });

        if (navigator.bluetooth && navigator.bluetooth.getDevices) {
            navigator.bluetooth.getDevices().then(devices => {
                const myPrinter = devices.find(d => d.name && (d.name.includes('MTH') || d.name.includes('Printer')));
                if (myPrinter) conectarDispositivo(myPrinter);
            });
        }
    };

    function cargarInventario() {
        fetch(GOOGLE_SCRIPT_URL + "?sheet=MADERA ASERRADA")
        .then(res => res.json())
        .then(data => { inventarioRemoto = data; })
        .catch(e => console.error("Error cargando inventario:", e));
    }

    async function conectarBluetooth() {
        try {
            bluetoothDevice = await navigator.bluetooth.requestDevice({
                acceptAllDevices: true,
                optionalServices: ['000018f0-0000-1000-8000-00805f9b34fb', '0000ff00-0000-1000-8000-00805f9b34fb']
            });
            conectarDispositivo(bluetoothDevice);
        } catch (error) { console.log(error); }
    }

    async function conectarDispositivo(device) {
        bluetoothDevice = device;
        const server = await bluetoothDevice.gatt.connect();
        let characteristic;
        try {
            const service = await server.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');
            characteristic = await service.getCharacteristic('00002af1-0000-1000-8000-00805f9b34fb');
        } catch (e) {
            const service = await server.getPrimaryService('0000ff00-0000-1000-8000-00805f9b34fb');
            characteristic = await service.getCharacteristic('0000ff02-0000-1000-8000-00805f9b34fb');
        }
        printCharacteristic = characteristic;
        document.getElementById('btStatus').innerText = "‚úÖ Conectado: " + device.name;
    }

    function generarTabla(isManual = false) {
        let largoMin = parseInt(document.getElementById('largoMin').value);
        let largoMax = parseInt(document.getElementById('largoMax').value);

        // Si uno est√° vac√≠o, igualar al otro para permitir un solo largo
        if (isNaN(largoMin) && !isNaN(largoMax)) largoMin = largoMax;
        if (isNaN(largoMax) && !isNaN(largoMin)) largoMax = largoMin;

        if (isNaN(largoMin) || isNaN(largoMax) || largoMin > largoMax) {
            if (isManual) alert("Por favor, define un rango de largos v√°lido.");
            return;
        }

        const table = document.getElementById('tallyTable');
        table.innerHTML = ''; 

        const thead = table.createTHead();
        const headerRow = thead.insertRow();
        let thAncho = document.createElement('th');
        thAncho.innerText = "Ancho (in)";
        headerRow.appendChild(thAncho);

        for (let largo = largoMin; largo <= largoMax; largo++) {
            let th = document.createElement('th');
            th.innerText = `${largo}' Pzs`;
            headerRow.appendChild(th);
        }
        th = document.createElement('th');
        th.innerHTML = "Total Pzs";
        th.className = "total-col";
        headerRow.appendChild(th);

        th = document.createElement('th');
        th.innerHTML = "Total PT";
        th.className = "total-col";
        headerRow.appendChild(th);

        const tbody = table.createTBody();
        for (let ancho = 1; ancho <= 23; ancho++) {
            const row = tbody.insertRow();
            let cell = row.insertCell();
            let th = document.createElement('th');
            th.innerText = ancho + '"';
            cell.replaceWith(th);

            for (let largo = largoMin; largo <= largoMax; largo++) {
                cell = row.insertCell();
                cell.innerHTML = `<input type="number" min="0" oninput="calcularTotales()" onkeydown="manejarEnter(event, ${ancho}, ${largo})" data-ancho="${ancho}" data-largo="${largo}">`;
            }
            row.insertCell().className = 'total-col';
            row.insertCell().className = 'total-col';
        }

        const tfoot = table.createTFoot();
        const footerRow = tfoot.insertRow();
        footerRow.insertCell().innerHTML = "TOTALES";

        for (let largo = largoMin; largo <= largoMax; largo++) {
            footerRow.insertCell(); 
        }
        footerRow.insertCell().id = 'granTotalPiezas'; 
        footerRow.insertCell().id = 'granTotalPT'; 
        
        calcularTotales(); 
    }

    function manejarEnter(event, ancho, largo) {
        if (event.key === 'Enter') {
            event.preventDefault();
            const siguienteAncho = ancho + 1;
            const nextInput = document.querySelector(`input[data-ancho="${siguienteAncho}"][data-largo="${largo}"]`);
            if (nextInput) {
                nextInput.focus();
                nextInput.select();
            }
        }
    }

    function calcularTotales() {
        const espesor = parseFloat(document.getElementById('espesor').value);
        const table = document.getElementById('tallyTable');
        if (!table || !table.tHead || !table.tHead.rows.length || !table.tBodies.length || !table.tFoot || !table.tFoot.rows.length) return;

        const tbody = table.tBodies[0];
        const tfoot = table.tFoot;
        const numCols = table.tHead.rows[0].cells.length;
        const numLargoCols = numCols - 3;

        let granTotalPiezas = 0;
        let granTotalPT = 0;
        const totalesPorLargo = new Array(numLargoCols).fill(0);

        for (const row of tbody.rows) {
            let totalPiezasFila = 0;
            let totalPTFila = 0;
            const ancho = parseInt(row.cells[0].innerText);
            if (isNaN(ancho)) continue;

            for (let i = 0; i < numLargoCols; i++) {
                const input = row.cells[i + 1].getElementsByTagName('input')[0];
                const piezas = parseInt(input.value) || 0;
                const largo = parseFloat(input.dataset.largo);
                totalPiezasFila += piezas;
                totalesPorLargo[i] += piezas;
                totalPTFila += (espesor * ancho * largo / 12) * piezas;
            }

            row.cells[numCols - 2].innerText = totalPiezasFila;
            row.cells[numCols - 1].innerText = totalPTFila.toFixed(2);
            granTotalPiezas += totalPiezasFila;
            granTotalPT += totalPTFila;
        }

        const footerRow = tfoot.rows[0];
        if (!footerRow) return;

        for (let i = 0; i < numLargoCols; i++) {
            footerRow.cells[i + 1].innerText = totalesPorLargo[i];
        }
        document.getElementById('granTotalPiezas').innerText = granTotalPiezas;
        document.getElementById('granTotalPT').innerText = granTotalPT.toFixed(2);
    }

    function obtenerAbreviaturaCA(calidad) {
        const mapa = { "SELECTA Y MEJOR": "SEL&M", "COMUN 1": "C1", "COMUN 2": "C2", "COMUNES": "COM", "COMUNES G-B": "CGB", "COMUN B": "CB", "COMUN Y MEJOR": "C&M", "M-R": "MR" };
        return mapa[calidad] || calidad.substring(0, 3).toUpperCase();
    }

    async function guardarTally() {
        const bulto = document.getElementById('bultoNo').value;
        if (!bulto) return alert("Ingresa el N√∫mero de Bulto.");
        if (inventarioRemoto.some(item => String(item.FARDO) === String(bulto))) return alert("‚õî El bulto " + bulto + " YA EXISTE.");

        const table = document.getElementById('tallyTable');
        if (!table.tHead || table.tHead.rows.length === 0) return alert("Genera la tabla primero.");

        const poa = document.getElementById('poa').value;
        const especieNombre = document.getElementById('especie').value;
        const espObj = especiesList.find(e => e.nombre === especieNombre);
        const espCode = espObj ? espObj.codigo : "GEN";

        const encabezado = {
            fecha: document.getElementById('fecha').value,
            poa: poa,
            bulto: bulto,
            especie: especieNombre,
            calidad: document.getElementById('calidad').value.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase(),
            espesor: document.getElementById('espesor').options[document.getElementById('espesor').selectedIndex].text,
            espesorVal: parseFloat(document.getElementById('espesor').value),
            condicion: document.getElementById('condicion').value,
            ubicacion: document.getElementById('ubicacion').value,
            ca: obtenerAbreviaturaCA(document.getElementById('calidad').value),
            tipoProducto: "Madera Aserrada",
            idCode: `MD-${poa}-${bulto}-${espCode}`
        };

        const detalles = [];
        const tbody = table.tBodies[0];
        const numCols = table.tHead.rows[0].cells.length;
        const numLargoCols = numCols - 3;

        for (const row of tbody.rows) {
            const ancho = parseInt(row.cells[0].innerText);
            for (let i = 0; i < numLargoCols; i++) {
                const input = row.cells[i + 1].getElementsByTagName('input')[0];
                const piezas = parseInt(input.value) || 0;
                if (piezas > 0) {
                    const largo = parseFloat(input.dataset.largo);
                    const pt = (encabezado.espesorVal * ancho * largo / 12) * piezas;
                    detalles.push({ ancho, largo, piezas, pt: parseFloat(pt.toFixed(2)) });
                }
            }
        }

        if (detalles.length === 0) return alert("Tabla vac√≠a.");

        const btn = document.querySelector('button[onclick="guardarTally()"]');
        btn.disabled = true;
        btn.innerText = "‚è≥ Guardando...";

        try {
            const payload = { tipo: "tally_aserrada", sheetName: "MADERA ASERRADA", ...encabezado, detalles, fechaSecado: "" };
            console.log("Enviando Tally Individual:", payload);

            const response = await fetch(GOOGLE_SCRIPT_URL, { 
                method: "POST", 
                mode: "cors",
                body: JSON.stringify(payload) 
            });
            
            const result = await response.json();
            if (result.result === "success") {
                alert("‚úÖ Tally guardado correctamente en la nube.");
                document.getElementById('bultoNo').value = parseInt(bulto) + 1;
                generarTabla();
                cargarInventario();
            } else {
                alert("‚ùå Error del servidor: " + result.message);
            }
        } catch (e) { 
            console.error(e);
            alert("‚ùå Error de conexi√≥n: " + e.message); 
        }
        finally { btn.disabled = false; btn.innerText = "üíæ GUARDAR EN NUBE"; }
    }

    function imprimirEtiquetaPC() {
        const fardo = document.getElementById('bultoNo').value;
        const totalPzs = document.getElementById('granTotalPiezas').innerText;
        const totalPT = document.getElementById('granTotalPT').innerText;
        if (totalPzs === "0") return alert("Sin datos.");

        const container = document.getElementById('printable-area');
        container.innerHTML = `
            <div class="label-page">
                <div class="lbl-header">
                    <div class="lbl-title">MADERA ASERRADA</div>
                    <div class="lbl-sub">#${fardo}</div>
                </div>
                <div class="lbl-main">
                    <div class="lbl-row">Especie: <b>${document.getElementById('especie').value}</b></div>
                    <div class="lbl-row">Calidad: <b>${document.getElementById('calidad').value}</b></div>
                    <div class="lbl-dims">Grosor: ${document.getElementById('espesor').options[document.getElementById('espesor').selectedIndex].text}</div>
                </div>
                <div class="lbl-footer">
                    <div class="lbl-col-print"><div class="lbl-head">PIEZAS</div><div class="lbl-val">${totalPzs}</div></div>
                    <div class="lbl-col-print"><div class="lbl-head">PIES TABLARES</div><div class="lbl-val">${totalPT}</div></div>
                </div>
            </div>
        `;
        window.print();
    }

    async function imprimirEtiquetaActual() {
        if (!printCharacteristic) return alert("Conecta la impresora.");
        // L√≥gica de impresi√≥n BT similar a la de PC pero enviando comandos TSPL
        alert("Enviando a impresora Bluetooth...");
    }

    function exportarCSV() {
        const table = document.getElementById('tallyTable');
        if (!table.tBodies.length) return alert("No hay datos para exportar.");
        
        let csv = [];
        const rows = table.querySelectorAll('tr');
        
        for (const row of rows) {
            const cols = row.querySelectorAll('td, th');
            const rowData = [];
            for (const col of cols) {
                const input = col.querySelector('input');
                rowData.push(input ? input.value : col.innerText);
            }
            csv.push(rowData.join(","));
        }

        const csvFile = new Blob([csv.join("\n")], { type: "text/csv" });
        const downloadLink = document.createElement("a");
        downloadLink.download = `Tally_Bulto_${document.getElementById('bultoNo').value}.csv`;
        downloadLink.href = window.URL.createObjectURL(csvFile);
        downloadLink.style.display = "none";
        document.body.appendChild(downloadLink);
        downloadLink.click();
    }

    function procesarExcel(event) {
        const file = event.target.files[0];
        if (!file) return;

        const statusDiv = document.getElementById('importStatus');
        statusDiv.innerText = "‚è≥ Leyendo archivo...";

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);

                if (jsonData.length === 0) {
                    alert("El archivo parece estar vac√≠o.");
                    statusDiv.innerText = "";
                    return;
                }

                let totalPT = 0;
                let fardosSet = new Set();
                let sinIDCode = 0;
                let generatedIDCode = 0;
                let totalPiezas = 0;
                
                // Valores globales para generaci√≥n de ID
                const poaGlobal = document.getElementById('poa').value || "SIN-POA";
                const especieGlobal = document.getElementById('especie').value;

                jsonData.forEach(row => {
                    const fardo = getVal(row, ['fardo', 'bulto', '# fardo', 'no. bulto', 'bundle', 'paquete', 'fardo #']);
                    if (fardo) fardosSet.add(String(fardo));

                    const pt = parseFloat(getVal(row, ['pies tablares', 'pt', 'p2', 'board feet', 'pies'])) || 0;
                    totalPT += pt;

                    const pzs = parseInt(getVal(row, ['piezas', 'pzs', 'pcs', 'count', 'cantidad', 'qty'])) || 0;
                    totalPiezas += pzs;

                    let idCode = getVal(row, ['id code', 'idcode', 'codigo', 'barcode']);
                    if (!idCode || String(idCode).trim() === "") {
                        if (fardo) {
                            // Generar ID CODE autom√°ticamente si falta
                            const especieNombre = getVal(row, ['especie', 'species']) || especieGlobal;
                            const espObj = especiesList.find(e => e.nombre.toLowerCase() === especieNombre.toLowerCase());
                            const espCode = espObj ? espObj.codigo : "GEN";
                            const poa = getVal(row, ['poa']) || poaGlobal;
                            
                            idCode = `MD-${poa}-${fardo}-${espCode}`;
                            row['ID CODE'] = idCode; // Guardar en el objeto para uso posterior
                            generatedIDCode++;
                        } else {
                            sinIDCode++;
                        }
                    }
                });

                const resumen = `üìä Resumen de Importaci√≥n:\n\n` +
                                `üì¶ Total Bultos detectados: ${fardosSet.size}\n` +
                                `üìè Total Pies Tablares: ${totalPT.toFixed(2)}\n` +
                                `üî¢ Total Piezas: ${totalPiezas}\n` +
                                `üÜî ID Codes: ${generatedIDCode > 0 ? '‚ö†Ô∏è ' + generatedIDCode + ' generados auto' : '‚úÖ Todos presentes'}\n` +
                                (sinIDCode > 0 ? `‚ùå ${sinIDCode} filas sin ID ni Fardo (omitidas)\n\n` : `\n`) +
                                `¬øQu√© desea hacer?\n\n` +
                                `[ACEPTAR] -> Cargar en la tabla para revisar (Solo recomendado si es 1 bulto).\n` +
                                `[CANCELAR] -> Cancelar y no hacer nada.`;

                if (confirm(resumen)) {
                    if (fardosSet.size > 1) {
                        if (confirm("‚ö†Ô∏è Se detectaron VARIOS bultos. ¬øDesea intentar guardarlos TODOS directamente en la nube ahora mismo?")) {
                            guardarBulkExcel(jsonData);
                        } else { llenarTablaDesdeExcel(jsonData); }
                    } else { llenarTablaDesdeExcel(jsonData); }
                } else {
                    statusDiv.innerText = "Importaci√≥n cancelada.";
                }
            } catch (err) {
                console.error(err);
                alert("Error al procesar el archivo: " + err.message);
                statusDiv.innerText = "‚ùå Error en importaci√≥n";
            }
        };
        reader.readAsArrayBuffer(file);
    }

    async function guardarBulkExcel(data) {
        const statusDiv = document.getElementById('importStatus');
        
        // 1. Actualizar inventario remoto para saber qu√© ya existe y evitar duplicados
        statusDiv.innerText = "üîÑ Verificando duplicados en la nube...";
        try {
            const res = await fetch(GOOGLE_SCRIPT_URL + "?sheet=MADERA ASERRADA");
            const dataNube = await res.json();
            if(Array.isArray(dataNube)) inventarioRemoto = dataNube;
        } catch(e) { console.warn("No se pudo actualizar inventario previo", e); }

        statusDiv.innerText = "üöÄ Preparando datos...";
        
        const bultosMap = {};
        const fechaGlobal = document.getElementById('fecha').value;
        const espesorValGlobal = parseFloat(document.getElementById('espesor').value);
        const espesorTxtGlobal = document.getElementById('espesor').options[document.getElementById('espesor').selectedIndex].text;
        const condicionGlobal = document.getElementById('condicion').value;
        const ubicacionGlobal = document.getElementById('ubicacion').value;
        const poaGlobal = document.getElementById('poa').value;

        data.forEach(row => {
            const bultoId = getVal(row, ['fardo', 'bulto', '# fardo', 'no. bulto', 'bundle', 'paquete', 'fardo #']);
            if (!bultoId) return;

            if (!bultosMap[bultoId]) {
                const especieNombre = getVal(row, ['especie', 'species']) || document.getElementById('especie').value;
                let calidadNombre = getVal(row, ['calidad', 'quality', 'grade']) || document.getElementById('calidad').value;
                calidadNombre = String(calidadNombre).normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase();

                const espObj = especiesList.find(e => e.nombre.toLowerCase() === especieNombre.toLowerCase());
                const espCode = espObj ? espObj.codigo : "GEN";
                const poa = getVal(row, ['poa']) || poaGlobal;

                const grosorRow = getVal(row, ['grosor', 'espesor', 'thickness']);
                let thicknessTxt = String(espesorValGlobal);
                let thicknessVal = espesorValGlobal;
                
                if (grosorRow !== null) {
                    if (String(grosorRow).includes('/')) {
                        const parts = String(grosorRow).split('/');
                        thicknessVal = parseFloat(parts[0]) / parseFloat(parts[1]);
                    } else {
                        thicknessVal = parseFloat(grosorRow);
                    }
                    thicknessTxt = !isNaN(thicknessVal) ? String(thicknessVal) : String(grosorRow);
                }

                bultosMap[bultoId] = {
                    fecha: getVal(row, ['fecha', 'fecha de ingreso']) || fechaGlobal,
                    bulto: bultoId,
                    especie: especieNombre,
                    calidad: calidadNombre,
                    ca: getVal(row, ['ca']) || obtenerAbreviaturaCA(calidadNombre),
                    espesor: thicknessTxt,
                    espesorVal: thicknessVal,
                    condicion: getVal(row, ['condicion', 'condition']) || condicionGlobal,
                    ubicacion: getVal(row, ['ubicacion', 'location']) || ubicacionGlobal,
                    poa: poa,
                    tipoProducto: getVal(row, ['tipo de producto', 'producto']) || "Madera Aserrada",
                    idCode: getVal(row, ['id code', 'idcode', 'codigo', 'barcode']) || `MD-${poa}-${bultoId}-${espCode}`,
                    fechaSecado: getVal(row, ['fecha de secado', 'secado']) || "",
                    detalles: []
                };
            }

            const a = parseFloat(getVal(row, ['ancho', 'width', 'ancho "']));
            const l = parseFloat(getVal(row, ['largo', 'length', 'largo \'']));
            const p = parseInt(getVal(row, ['piezas', 'pzs', 'qty', 'cantidad']));

            if (!isNaN(a) && !isNaN(l) && !isNaN(p)) {
                const ptExcel = parseFloat(getVal(row, ['pies tablares', 'pt', 'p2', 'board feet', 'pies']));
                const pt = !isNaN(ptExcel) ? ptExcel : (bultosMap[bultoId].espesorVal * a * l / 12) * p;
                bultosMap[bultoId].detalles.push({ ancho: a, largo: l, piezas: p, pt: parseFloat(pt.toFixed(2)) });
            }
        });

        const bultosArray = Object.values(bultosMap);
        if (bultosArray.length === 0) {
            alert("‚ùå No se detectaron bultos o piezas v√°lidas en el Excel. Revisa los nombres de las columnas.");
            statusDiv.innerText = "‚ùå Error: Sin datos v√°lidos";
            return;
        }
        
        let guardados = 0;
        let omitidos = 0;
        let errores = [];

        // Procesar uno por uno sin detenerse si hay error individual
            for (const fardo of bultosArray) {
                // VERIFICAR SI YA EXISTE EN LA NUBE
                const existe = inventarioRemoto.some(r => String(r['FARDO']) === String(fardo.bulto));
                if (existe) {
                    console.log(`Saltando Bulto #${fardo.bulto} (Ya existe en sistema)`);
                    omitidos++;
                    continue;
                }

                if (fardo.detalles.length === 0) {
                    console.warn(`Bulto #${fardo.bulto} no tiene piezas v√°lidas, saltando...`);
                    continue;
                }

                statusDiv.innerText = `‚è≥ Guardando Bulto #${fardo.bulto}...`;
                const payload = { tipo: "tally_aserrada", sheetName: "MADERA ASERRADA", ...fardo };

                try {
                    const response = await fetch(GOOGLE_SCRIPT_URL, { 
                        method: "POST", 
                        mode: "cors",
                        body: JSON.stringify(payload) 
                    });
                    
                    const result = await response.json();
                    if (result.result !== "success") {
                        throw new Error(result.message);
                    }
                    guardados++;
                    // Agregamos a la lista local temporalmente para que si falla el siguiente, este ya cuente como existente
                    inventarioRemoto.push({ FARDO: fardo.bulto });
                } catch (err) {
                    console.error(`Error en Bulto #${fardo.bulto}:`, err);
                    errores.push(`Bulto #${fardo.bulto}: ${err.message}`);
                }
            }
            
            let msg = `üìä Proceso finalizado.\n\n‚úÖ Nuevos guardados: ${guardados}\n‚è≠Ô∏è Omitidos (Ya exist√≠an): ${omitidos}`;
            
            if (errores.length > 0) {
                msg += `\n\n‚ùå Errores (${errores.length}):\n` + errores.slice(0, 5).join("\n") + (errores.length > 5 ? "\n..." : "");
                statusDiv.innerText = "‚ö†Ô∏è Finalizado con errores.";
            } else {
                statusDiv.innerText = "‚úÖ Importaci√≥n masiva completada.";
            }
            
            alert(msg);
    }

    function llenarTablaDesdeExcel(data) {
        const table = document.getElementById('tallyTable');
        
        // Detectar rangos del Excel para ajustar la tabla si es necesario
        let minL = 99, maxL = 0;
        data.forEach(row => {
            const l = parseInt(row['Largo'] || row['LARGO'] || row['largo'] || row['Largo \'']);
            if (l) {
                if (l < minL) minL = l;
                if (l > maxL) maxL = l;
            }
        });

        // Si el rango del Excel es mayor al actual o la tabla no existe, regenerar
        const currentMin = parseInt(document.getElementById('largoMin').value) || 3;
        const currentMax = parseInt(document.getElementById('largoMax').value) || 16;
        
        if (!table.tBodies.length || minL < currentMin || maxL > currentMax) {
            document.getElementById('largoMin').value = Math.min(minL, currentMin);
            document.getElementById('largoMax').value = Math.max(maxL, currentMax);
            generarTabla();
        }

        data.forEach(row => {
            const a = parseFloat(getVal(row, ['ancho', 'width', 'ancho "']));
            const l = parseFloat(getVal(row, ['largo', 'length', 'largo \'']));
            const p = parseInt(getVal(row, ['piezas', 'pzs', 'qty', 'cantidad']));

            if (!isNaN(a) && !isNaN(l) && !isNaN(p)) {
                const input = table.querySelector(`input[data-ancho="${a}"][data-largo="${l}"]`);
                if (input) {
                    input.value = (parseInt(input.value) || 0) + p;
                }
            }
        });
        calcularTotales();
        document.getElementById('importStatus').innerText = "‚úÖ Datos cargados.";
        table.scrollIntoView({ behavior: 'smooth' });
    }
</script>
</body>
</html>
