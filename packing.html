<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Packing List - GIBOR S.A.</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @media print {
            .no-print { display: none !important; }
            body { background: white; }
            .print-container { shadow: none; border: none; }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans p-4 md:p-8">

    <div class="max-w-6xl mx-auto bg-white shadow-2xl rounded-3xl overflow-hidden print-container">
        <div class="p-8 border-b-4 border-slate-900">
            <div class="flex justify-between items-start mb-6">
                <div class="flex items-center gap-4">
                    <img src="logo_gibor.png" alt="GIBOR S.A." class="h-20 w-auto object-contain" onerror="this.src='https://via.placeholder.com/150?text=LOGO+GIBOR'">
                    <div>
                        <h1 class="text-3xl font-black text-slate-900 tracking-tighter">GIBOR, S.A.</h1>
                        <p class="text-sm font-bold text-slate-500 uppercase">Sistema de Inventarios - Packing List</p>
                    </div>
                </div>
                <div class="text-right no-print">
                    <button onclick="exportarExcel()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 transition-all">
                        <i data-lucide="file-spreadsheet"></i> Descargar Excel
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
                <div class="space-y-1">
                    <label class="font-bold text-slate-400 uppercase text-[10px]">Producto</label>
                    <input type="text" id="producto" value="Estructura" class="w-full font-bold border-b border-gray-200 focus:border-blue-500 outline-none pb-1">
                </div>
                <div class="space-y-1">
                    <label class="font-bold text-slate-400 uppercase text-[10px]">Especie</label>
                    <input type="text" id="especie" placeholder="Ej: Manchiche" class="w-full font-bold border-b border-gray-200 focus:border-blue-500 outline-none pb-1">
                </div>
                <div class="space-y-1">
                    <label class="font-bold text-slate-400 uppercase text-[10px]">Fecha</label>
                    <input type="text" id="fecha" class="w-full font-bold border-b border-gray-200 focus:border-blue-500 outline-none pb-1">
                </div>
                <div class="md:col-span-2 space-y-1">
                    <label class="font-bold text-slate-400 uppercase text-[10px]">Cliente</label>
                    <input type="text" id="cliente" placeholder="Nombre del Cliente" class="w-full font-bold border-b border-gray-200 focus:border-blue-500 outline-none pb-1">
                </div>
                <div class="md:col-span-3 space-y-1">
                    <label class="font-bold text-slate-400 uppercase text-[10px]">DirecciÃ³n</label>
                    <input type="text" id="direccion" placeholder="DirecciÃ³n de entrega" class="w-full font-bold border-b border-gray-200 focus:border-blue-500 outline-none pb-1">
                </div>
            </div>
        </div>

        <div class="p-6 bg-slate-50 border-b border-gray-200 no-print">
            <div class="flex gap-4">
                <div class="relative flex-1">
                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"></i>
                    <input type="text" id="loteInput" placeholder="Ingrese Lotes (separados por coma, ej: 101, 102)..." 
                        class="w-full pl-10 pr-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <button onclick="buscarLote()" class="bg-slate-900 text-white px-8 py-3 rounded-xl font-bold hover:bg-slate-800 transition-all flex items-center gap-2">
                    CARGAR FARDOS
                </button>
            </div>
            <p id="status" class="text-xs mt-2 text-slate-500"></p>
        </div>

        <div class="p-0 overflow-x-auto">
            <table id="packingTable" class="w-full text-[11px] text-center border-collapse">
                <thead>
                    <tr class="bg-slate-900 text-white uppercase tracking-tighter">
                        <th class="p-2 border border-slate-700 no-print">Incluir</th>
                        <th class="p-2 border border-slate-700">Item</th>
                        <th class="p-2 border border-slate-700">Paquete</th>
                        <th class="p-2 border border-slate-700">Grosor</th>
                        <th class="p-2 border border-slate-700">Ancho</th>
                        <th class="p-2 border border-slate-700">Piezas</th>
                        <th class="p-2 border border-slate-700">Largo '</th>
                        <th class="p-2 border border-slate-700 bg-blue-900">M2</th>
                        <th class="p-2 border border-slate-700 bg-blue-900">MÂ³</th>
                        <th class="p-2 border border-slate-700 bg-blue-900">PÂ²</th>
                        <th class="p-2 border border-slate-700 bg-blue-900">PL</th>
                        <th class="p-2 border border-slate-700 bg-blue-900">ML</th>
                    </tr>
                </thead>
                <tbody id="tableBody" class="font-mono text-slate-700">
                    </tbody>
                <tfoot id="tableFoot" class="bg-slate-100 font-bold">
                    </tfoot>
            </table>
        </div>

        <div class="p-8 bg-slate-50 flex justify-between items-center no-print">
            <div class="text-slate-500 text-sm">
                * Marque los fardos que desea rebajar y generar en el reporte.
            </div>
            <button onclick="rebajarInventario()" class="bg-red-600 hover:bg-red-700 text-white px-10 py-4 rounded-2xl font-black text-lg shadow-xl shadow-red-600/20 transition-all flex items-center gap-3">
                <i data-lucide="trash-2"></i> REBAJAR SELECCIONADOS
            </button>
        </div>
    </div>

    <script>
        lucide.createIcons();
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyJm67IZXi_zHsxQv3mqosqb6-RyKp4-j-h-kqdP153HTN8t6lt7BPE5BrwSzphArkx/exec";
        let fardosCargados = [];

        document.getElementById('fecha').value = new Date().toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });

        // Helper para obtener valores buscando en mÃºltiples variantes de nombres de columna
        function getVal(row, keys) {
            if (!row) return '';
            // 1. BÃºsqueda exacta
            for (const k of keys) {
                if (row[k] !== undefined && row[k] !== null && row[k] !== "") return row[k];
            }
            // 2. BÃºsqueda insensible a mayÃºsculas/minÃºsculas
            const rowKeys = Object.keys(row);
            for (const k of keys) {
                const match = rowKeys.find(rk => rk.toLowerCase().trim() === k.toLowerCase().trim());
                if (match && row[match] !== undefined && row[match] !== "") return row[match];
            }
            return '';
        }

        // Helper para convertir fracciones (3/4) a decimales
        function parseDimension(val) {
            if (!val) return 0;
            const s = String(val).replace(/'/g, '').trim(); // Quitar comillas si hay
            if (s.includes('/')) {
                const parts = s.split('/');
                return parseFloat(parts[0]) / parseFloat(parts[1]);
            }
            return parseFloat(s) || 0;
        }

        async function buscarLote() {
            const input = document.getElementById('loteInput').value;
            // Separar por comas para permitir mÃºltiples lotes
            const searchTerms = input.split(',').map(s => s.trim().toLowerCase()).filter(s => s);
            const status = document.getElementById('status');
            if (searchTerms.length === 0) return;

            status.innerText = "ðŸ”„ Buscando en inventario...";
            try {
                const res = await fetch(`${SCRIPT_URL}?sheet=PRODUCTO TERMINADO`);
                const data = await res.json();
                
                // Filtra SOLO por Lote, permitiendo mÃºltiples bÃºsquedas
                fardosCargados = data.filter(row => {
                    const rowLote = String(getVal(row, ['Lote', '# Lote', 'LOTE'])).toLowerCase();
                    
                    // Verifica si el lote de la fila incluye alguno de los tÃ©rminos buscados
                    return searchTerms.some(term => rowLote.includes(term));
                });

                renderTabla();
                
                if (fardosCargados.length > 0) {
                    status.innerText = `âœ… Se encontraron ${fardosCargados.length} fardos asociados a los lotes buscados.`;
                } else {
                    status.innerText = `âš ï¸ No se encontraron fardos para "${input}".`;
                }
            } catch (e) {
                console.error(e);
                status.innerText = "âŒ Error al conectar con la base de datos.";
            }
        }

        function renderTabla() {
            const body = document.getElementById('tableBody');
            body.innerHTML = '';
            
            // Auto-detectar producto desde los datos cargados
            let unidadDetectada = '';
            if (fardosCargados.length > 0) {
                const primerFardo = fardosCargados[0];
                const productoDetectado = getVal(primerFardo, ['Producto', 'PRODUCTO', 'Product']);
                unidadDetectada = String(getVal(primerFardo, ['Unidad', 'UNIDAD', 'Unit'])).toLowerCase();

                if (productoDetectado) {
                    document.getElementById('producto').value = productoDetectado;
                }
            }

            let lastFardo = null;
            let itemCounter = 1;
            const productoInput = document.getElementById('producto').value.toLowerCase();
            
            // Determinar si es lineal: Prioridad a la Unidad detectada, luego al nombre
            let esLineal = false;
            // Prioridad absoluta a palabras clave del producto para forzar la vista correcta
            if (productoInput.includes('piso') || productoInput.includes('barnizado') || productoInput.includes('crudo')) {
                esLineal = false; // M2 a la izquierda
            } else if (productoInput.includes('tranquilla') || productoInput.includes('zocalo') || productoInput.includes('deck')) {
                esLineal = true;
            } else if (unidadDetectada === 'ml') {
                esLineal = true;
            } else {
                esLineal = false;
            }

            // Actualizar Encabezados dinÃ¡micamente
            const theadRow = document.querySelector('#packingTable thead tr');
            theadRow.innerHTML = `
                <th class="p-2 border border-slate-700 no-print">Incluir</th>
                <th class="p-2 border border-slate-700">Item</th>
                <th class="p-2 border border-slate-700">Paquete</th>
                <th class="p-2 border border-slate-700">Grosor</th>
                <th class="p-2 border border-slate-700">Ancho</th>
                <th class="p-2 border border-slate-700">Piezas</th>
                <th class="p-2 border border-slate-700">Largo '</th>
                ${esLineal ? 
                    `<th class="p-2 border border-slate-700 bg-blue-900">M2</th>
                     <th class="p-2 border border-slate-700 bg-blue-900">MÂ³</th>
                     <th class="p-2 border border-slate-700 bg-blue-900">PÂ²</th>
                     <th class="p-2 border border-slate-700 bg-blue-900">PL</th>
                     <th class="p-2 border border-slate-700 bg-blue-900">ML</th>` 
                    : 
                    `<th class="p-2 border border-slate-700 bg-blue-900">ML</th>
                     <th class="p-2 border border-slate-700 bg-blue-900">MÂ³</th>
                     <th class="p-2 border border-slate-700 bg-blue-900">PÂ²</th>
                     <th class="p-2 border border-slate-700 bg-blue-900">PL</th>
                     <th class="p-2 border border-slate-700 bg-blue-900">M2</th>`
                }
            `;
            
            fardosCargados.forEach((f, index) => {
                // Usar getVal para recuperar datos independientemente del nombre exacto de la columna
                const piezas = parseFloat(getVal(f, ['Piezas', 'PIEZAS', 'Pzs'])) || 0;
                const grosor = parseDimension(getVal(f, ['Grosor', 'GROSOR', 'Grosor "', 'Espesor']));
                const ancho = parseFloat(getVal(f, ['Ancho', 'ANCHO', 'Ancho "'])) || 0;
                const largo = parseFloat(getVal(f, ['Largo', 'LARGO', "Largo '", 'Largo_Ft'])) || 0;
                const fardoId = getVal(f, ['Fardo', '# Fardo', 'FARDO']);

                // LÃ³gica de Item: Reiniciar a 1 si cambia el fardo
                if (fardoId !== lastFardo) {
                    itemCounter = 1;
                    lastFardo = fardoId;
                } else {
                    itemCounter++;
                }

                // FÃ³rmulas Corregidas (Coincidentes con Google Sheets / Registro)
                // M2 = Piezas * Largo(m) * Ancho(m)
                const m2 = piezas * (largo * 0.3048) * (ancho * 0.0254);
                // ML = Piezas * Largo(m)
                const ml = piezas * (largo * 0.3048);
                // P2 (Pie Tablar) = (Piezas * Grosor" * Ancho" * Largo') / 12
                const p2 = (piezas * grosor * ancho * largo) / 12;
                // M3 = M2 * Grosor(m)
                const m3 = m2 * (grosor * 0.0254);
                // PL (Pie Lineal) = Piezas * Largo'
                const pl = piezas * largo;

                const row = document.createElement('tr');
                row.className = "border-b border-gray-100 hover:bg-blue-50 transition-colors";
                row.innerHTML = `
                    <td class="p-2 border no-print"><input type="checkbox" checked class="w-4 h-4 fardo-check" data-index="${index}"></td>
                    <td class="p-2 border">${itemCounter}</td>
                    <td class="p-2 border font-bold">${fardoId || '-'}</td>
                    <td class="p-2 border">${grosor.toFixed(2)}</td>
                    <td class="p-2 border">${ancho}</td>
                    <td class="p-2 border">${piezas}</td>
                    <td class="p-2 border">${largo}</td>
                    ${esLineal ? 
                        `<td class="p-2 border font-bold">${m2.toFixed(2)}</td>
                         <td class="p-2 border">${m3.toFixed(2)}</td>
                         <td class="p-2 border">${p2.toFixed(2)}</td>
                         <td class="p-2 border">${pl.toFixed(2)}</td>
                         <td class="p-2 border font-bold text-blue-700">${ml.toFixed(2)}</td>`
                        :
                        `<td class="p-2 border font-bold text-blue-700">${ml.toFixed(2)}</td>
                         <td class="p-2 border">${m3.toFixed(2)}</td>
                         <td class="p-2 border">${p2.toFixed(2)}</td>
                         <td class="p-2 border">${pl.toFixed(2)}</td>
                         <td class="p-2 border font-bold">${m2.toFixed(2)}</td>`
                    }
                `;
                body.appendChild(row);
            });
            actualizarTotales();
        }

        function actualizarTotales() {
            const checkboxes = document.querySelectorAll('.fardo-check:checked');
            let tM2 = 0, tM3 = 0, tP2 = 0, tPL = 0, tML = 0;
            
            const productoInput = document.getElementById('producto').value.toLowerCase();
            
            // Misma lÃ³gica de detecciÃ³n para totales
            let unidadDetectada = '';
            if (fardosCargados.length > 0) unidadDetectada = String(getVal(fardosCargados[0], ['Unidad', 'UNIDAD'])).toLowerCase();
            
            let esLineal = false;
            if (productoInput.includes('piso') || productoInput.includes('barnizado') || productoInput.includes('crudo')) {
                esLineal = false;
            } else if (productoInput.includes('tranquilla') || productoInput.includes('zocalo') || productoInput.includes('deck')) {
                esLineal = true;
            } else if (unidadDetectada === 'ml') {
                esLineal = true;
            }

            checkboxes.forEach(cb => {
                const index = parseInt(cb.dataset.index);
                const f = fardosCargados[index];
                if (!f) return;

                const piezas = parseFloat(getVal(f, ['Piezas', 'PIEZAS', 'Pzs'])) || 0;
                const grosor = parseDimension(getVal(f, ['Grosor', 'GROSOR', 'Grosor "', 'Espesor']));
                const ancho = parseFloat(getVal(f, ['Ancho', 'ANCHO', 'Ancho "'])) || 0;
                const largo = parseFloat(getVal(f, ['Largo', 'LARGO', "Largo '", 'Largo_Ft'])) || 0;

                const m2 = piezas * (largo * 0.3048) * (ancho * 0.0254);
                const ml = piezas * (largo * 0.3048);
                const p2 = (piezas * grosor * ancho * largo) / 12;
                const m3 = m2 * (grosor * 0.0254);
                const pl = piezas * largo;

                tM2 += m2; tM3 += m3; tP2 += p2; tPL += pl; tML += ml;
            });

            const foot = document.getElementById('tableFoot');
            foot.innerHTML = `
                <tr class="bg-slate-200 text-slate-900 uppercase text-[10px]">
                    <td colspan="7" class="p-2 border text-right font-black">TOTALES SELECCIONADOS:</td>
                    ${esLineal ? 
                        `<td class="p-2 border font-black">${tM2.toFixed(2)}</td>
                         <td class="p-2 border font-black">${tM3.toFixed(2)}</td>
                         <td class="p-2 border font-black">${tP2.toFixed(2)}</td>
                         <td class="p-2 border font-black">${tPL.toFixed(2)}</td>
                         <td class="p-2 border font-black text-blue-800">${tML.toFixed(2)}</td>`
                        :
                        `<td class="p-2 border font-black text-blue-800">${tML.toFixed(2)}</td>
                         <td class="p-2 border font-black">${tM3.toFixed(2)}</td>
                         <td class="p-2 border font-black">${tP2.toFixed(2)}</td>
                         <td class="p-2 border font-black">${tPL.toFixed(2)}</td>
                         <td class="p-2 border font-black text-blue-800">${tM2.toFixed(2)}</td>`
                    }
                </tr>
            `;
        }

        // Escuchar cambios en checkboxes para recalcular totales
        document.getElementById('tableBody').addEventListener('change', function(e) {
            if(e.target.classList.contains('fardo-check')) {
                actualizarTotales();
            }
        });

        // Actualizar tabla al cambiar el producto para ajustar columnas (M2/ML)
        document.getElementById('producto').addEventListener('input', function() {
            if (fardosCargados.length > 0) renderTabla();
        });

        async function rebajarInventario() {
            const seleccionados = Array.from(document.querySelectorAll('.fardo-check:checked'));
            if (seleccionados.length === 0) return alert("Seleccione al menos un fardo.");

            if (!confirm(`Â¿Desea rebajar ${seleccionados.length} fardos del inventario y moverlos a SALIDA PTE?`)) return;

            const btn = document.querySelector('button[onclick="rebajarInventario()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin"></i> Procesando...';
            btn.disabled = true;
            lucide.createIcons();

            try {
                const items = [];
                seleccionados.forEach(cb => {
                    const index = parseInt(cb.dataset.index);
                    const f = fardosCargados[index];
                    const lote = getVal(f, ['Lote', '# Lote', 'LOTE']);
                    const fardo = getVal(f, ['Fardo', '# Fardo', 'FARDO']);
                    items.push({ lote: lote, fardo: fardo });
                });

                const payload = {
                    action: "mover",
                    sheetOrigen: "PRODUCTO TERMINADO",
                    sheetDestino: "SALIDA PTE",
                    items: items
                };

                await fetch(SCRIPT_URL, {
                    method: "POST",
                    body: JSON.stringify(payload)
                });

                alert("âœ… OperaciÃ³n completada: Fardos movidos a SALIDA PTE.");
                
                // Recargar bÃºsqueda para actualizar la tabla
                buscarLote();

            } catch (e) {
                console.error(e);
                alert("âŒ Error al conectar con el servidor: " + e.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
                lucide.createIcons();
            }
        }

        function exportarExcel() {
            if (typeof XLSX === 'undefined') {
                alert("Error: La librerÃ­a Excel no se cargÃ³. Revise su conexiÃ³n.");
                return;
            }

            const checkboxes = document.querySelectorAll('.fardo-check:checked');
            if (checkboxes.length === 0) return alert("âš ï¸ No hay fardos seleccionados para exportar.");
            
            const productoInput = document.getElementById('producto').value.toLowerCase();
            
            let unidadDetectada = '';
            if (fardosCargados.length > 0 && fardosCargados[0]) unidadDetectada = String(getVal(fardosCargados[0], ['Unidad', 'UNIDAD']) || '').toLowerCase();
            
            let esLineal = false;
            if (productoInput.includes('piso') || productoInput.includes('barnizado') || productoInput.includes('crudo')) {
                esLineal = false;
            } else if (productoInput.includes('tranquilla') || productoInput.includes('zocalo') || productoInput.includes('deck')) {
                esLineal = true;
            } else if (unidadDetectada === 'ml') {
                esLineal = true;
            }

            let lastFardo = null;
            let itemCounter = 1;

            try {
                const data = [];
                // Recorremos los checkboxes para obtener los datos calculados
                checkboxes.forEach((cb, i) => {
                    const index = parseInt(cb.dataset.index);
                    const f = fardosCargados[index];
                    
                    if (!f) return;
                    
                    const piezas = parseFloat(getVal(f, ['Piezas', 'PIEZAS', 'Pzs'])) || 0;
                    const grosor = parseDimension(getVal(f, ['Grosor', 'GROSOR', 'Grosor "', 'Espesor']));
                    const ancho = parseFloat(getVal(f, ['Ancho', 'ANCHO', 'Ancho "'])) || 0;
                    const largo = parseFloat(getVal(f, ['Largo', 'LARGO', "Largo '", 'Largo_Ft'])) || 0;
                    const fardoId = getVal(f, ['Fardo', '# Fardo', 'FARDO']);

                    if (fardoId !== lastFardo) {
                        itemCounter = 1;
                        lastFardo = fardoId;
                    } else {
                        itemCounter++;
                    }

                    const m2 = piezas * (largo * 0.3048) * (ancho * 0.0254);
                    const ml = piezas * (largo * 0.3048);
                    const p2 = (piezas * grosor * ancho * largo) / 12;
                    const m3 = m2 * (grosor * 0.0254);
                    const pl = piezas * largo;

                    const rowData = {
                        "Item": itemCounter,
                        "Paquete": fardoId,
                        "Grosor": grosor,
                        "Ancho": ancho,
                        "Piezas": piezas,
                        "Largo": largo
                    };

                    if (esLineal) {
                        rowData["M2"] = parseFloat(m2.toFixed(2));
                        rowData["M3"] = parseFloat(m3.toFixed(2));
                        rowData["P2"] = parseFloat(p2.toFixed(2));
                        rowData["PL"] = parseFloat(pl.toFixed(2));
                        rowData["ML"] = parseFloat(ml.toFixed(2));
                    } else {
                        rowData["ML"] = parseFloat(ml.toFixed(2));
                        rowData["M3"] = parseFloat(m3.toFixed(2));
                        rowData["P2"] = parseFloat(p2.toFixed(2));
                        rowData["PL"] = parseFloat(pl.toFixed(2));
                        rowData["M2"] = parseFloat(m2.toFixed(2));
                    }

                    data.push(rowData);
                });

                // Crear hoja de cÃ¡lculo
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Packing List");

                // Nombre del archivo
                const cliente = document.getElementById('cliente').value.replace(/[^a-zA-Z0-9]/g, '_') || 'CLIENTE';
                XLSX.writeFile(wb, `Packing_List_${cliente}.xlsx`);
            } catch (e) {
                console.error(e);
                alert("Error al generar Excel: " + e.message);
            }
        }
    </script>
</body>
</html>